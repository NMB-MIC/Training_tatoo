@startuml
title Flowchart Upload BomWos - release v0.0.2

start
:Input file;

if (Filename starts with 'bomWos'?) then (yes)
  if (Filetype is .csv or .xlsx?) then (yes)
    :Read file into DataFrame (CSV/XLSX);
    :Drop columns matched '^Unnamed';

    ' -------- Header check (loop) --------
    :required = [updateAt, wosNo, brgNoValue, partNoValue, partComponentGroup, qty, parentPartNo];
    while (More required headers?) is (yes)
      :col = next required;
      if (col exists in DataFrame headers?) then (yes)
        ' ok -> continue
      else
        :Alert: Missing required column '{col}';
        stop
      endif
    endwhile (no)
    ' ------------------------------------

    ' ---------------- Empty check (loop) ----------------
    :rowIndex = 1;
    while (More rows to check empty?) is (yes)
      :row = next;
      if (Any required field empty in row?) then (yes)
        :Alert: Empty cell found at row {rowIndex};
        stop
      else
        :rowIndex = rowIndex + 1;
      endif
    endwhile (no)
    ' ---------------------------------------------------

    if (checknumber on 'qty' passed?
(number and > 0)) then (yes)

      ' --------------- Date check (loop) ----------------
      :rowIndex = 1;
      while (More rows to check date?) is (yes)
        :row = next;
        if (updateAt valid format in row?) then (yes)
          :rowIndex = rowIndex + 1;
        else
          :Alert: Invalid 'updateAt' at row {rowIndex};
          stop
        endif
      endwhile (no)
      ' --------------------------------------------------

      ' ------------ Unknown check (loop) ----------------
      :rowIndex = 1;
      while (More rows to check unknown?) is (yes)
        :row = next;
        if ("unknown" (case-insensitive) in any field?) then (yes)
          :Alert: Found 'unknown' at row {rowIndex};
          stop
        else
          :rowIndex = rowIndex + 1;
        endif
      endwhile (no)
      ' --------------------------------------------------

      :inserted=0; skipped=0;
      :Begin DB Transaction;

      while (More rows?) is (yes)
        :row = next;

        if (EXISTS in DB with EXACT match?
[wosNo, brgNoValue, partNoValue,
 parentPartNo, partComponentGroup, qty]) then (yes)
          :skipped++;\nskip row;
        else (no)
          :inserted++;
        endif
      endwhile (no)

      if (Commit OK?) then (yes)
        :Alert: success (Inserted={inserted}, Skipped={skipped});
        stop
      else (DB error on commit)
        :Rollback Transaction;
        :Alert: DB error on commit;\nUpload failed;
        stop
      endif

    else
      :Alert: 'qty' must be a number > 0;
      stop
    endif

  else
    :Alert: Filetype must be .csv or .xlsx;
    stop
  endif
else
  :Alert: Filename must start with 'bomWos';
  stop
endif
@enduml
